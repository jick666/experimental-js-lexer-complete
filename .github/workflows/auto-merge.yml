# .github/workflows/auto-merge.yml
name: Auto-Merge Reader PRs
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  enable-automerge:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.AUTOMERGE_TOKEN }}
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (!pr) {
              core.info('No pull request associated with this workflow run.');
              return;
            }
            const { data } = await github.rest.pulls.get({
              owner: pr.base.repo.owner.login,
              repo: pr.base.repo.name,
              pull_number: pr.number,
            });
            if (data.labels.some(l => l.name === 'reader') && data.mergeable_state === 'clean') {
              await github.rest.pulls.merge({
                owner: pr.base.repo.owner.login,
                repo: pr.base.repo.name,
                pull_number: pr.number,
                merge_method: 'squash'
              });
            } else {
              core.info('PR not ready for auto-merge.');
            }
